# TeBuilder

This repository provides a small, opinionated **builder** for assembly projects using a single `Makefile`.
It’s designed for modular assembly code organized into functional subdirectories, with convenient build, debug, test and analysis commands.

> **Note:** This README is written to match the `Makefile` included in the repository. Run `make help` to show the same targets from the build system.

---

## Project layout (what the Makefile expects)

```
.
├── Makefile          # build system (compile/link/test/analyze)
├── src/              # assembly source
│   ├── main.asm
│   ├── network/
│   ├── process/
│   ├── utils/
│   ├── stealth/      # optional
│   ├── persistence/  # optional
│   └── features/     # optional
├── include/          # assembly includes (syscalls, constants, macros)
├── tests/            # C test code; subdirs allowed (unit/, integration/, ...)
├── docs/             # generated docs
└── build/            # build outputs (object files, binaries) — ignored by VCS
```

---

## Quick start

1. Ensure you have the required toolchain installed:

   * `nasm` (assembler)
   * `ld` (linker)
   * `gcc` (C compiler for tests)
   * `objdump`, `nm`, `objcopy` (analysis helpers)
   * `gdb` (optional, used by the `debug` target)

2. Create the basic layout (idempotent):

```bash
make setup
```

3. Build the project:

```bash
make
```

The default binary is placed at `build/output` (value of `$(BIN)` in the Makefile).

4. Run tests (see Test Runner section below):

```bash
make test-build
```

---

## Useful Makefile targets

Run `make help` for a short menu; below are the main targets and what they do.

* `make` — build the project (`all`)
* `make re` — clean and rebuild
* `make debug` — build a separate debug binary (`$(BIN)-dbg`) with DWARF debug info and launch `gdb` on it
* `make test-build` — compile and run C tests under `tests/` (see Test Runner notes)
* `make disassemble` — disassemble `.text` of the resulting binary using `objdump`
* `make info` — show build configuration and discovered source file counts
* `make list-sources` — list discovered assembly sources by category
* `make shellcode` — extract `.text` section into `build/shellcode/text.bin` using `objcopy`
* `make analyze` — simple null-byte analysis of the binary
* `make map` — (if available / configured) produce a linker map (see Makefile `MAPFLAG`)
* `make clean` — remove files inside `build/` but keep the directory
* `make fclean` — remove the entire `build/` directory

---

## Test runner behavior

The test runner (`make test-build`) follows this flow:

1. Rebuilds the project (`re`).
2. **Compiles all** C test files found recursively under `tests/*.c` into executables placed next to their sources (e.g. `tests/unit/foo.c` → `tests/unit/foo`).
3. Runs the tests **grouped by directory**, in sorted order (skipping the top-level `tests/` directory itself).
4. By default the runner **stops on the first failing test**. To continue running remaining tests even after failures, set the environment variable:

```bash
CONTINUE_ON_TEST_FAILURE=1 make test-build
```

Output is colorized and prints per-test pass/fail messages.

---

## Debugging

* The `debug` target builds a debug binary with `DBG_FLAGS` appended to `ASMFLAGS` (the Makefile sets `DBG_FLAGS ?= -g -F dwarf`) and launches `gdb` on it:

```bash
make debug
```

This creates `build/output-dbg` with DWARF information generated by NASM. Use GEF or GDB to inspect sources, symbols, and step through assembly.

---

## Shellcode extraction & analysis

* Extract raw `.text` bytes:

```bash
make shellcode
# -> build/shellcode/text.bin
```

* Quick null-byte check:

```bash
make analyze
```

This counts zero bytes in the full binary and prints the first occurrences if any are found.

---

## Build flags and customization

* `ASMFLAGS` — NASM assembler flags. Default: `-f elf64 -I include/`
* `DBG_FLAGS` — default debug flags: `-g -F dwarf`
* `LDFLAGS` — linker flags (default: `-nostdlib`)
* Override or extend flags from the command line:

```bash
make ASMFLAGS="$(ASMFLAGS) -DDEBUG"      # example
make LDFLAGS="-nostdlib -static"
```

---

## Example workflow

A typical session:

```bash
# prepare layout
make setup

# build release binary
make

# run tests (stop on first failure)
make test-build

# build & debug with GDB (create build/output-dbg and invoke gdb)
make debug

# get disassembly
make disassemble

# extract text section
make shellcode

# cleanup
make clean    # remove generated files in build/
make fclean   # remove build/ directory entirely
```

---

## Notes & best practices

* The builder is intentionally simple and modular: add/remove module directories under `src/` and the Makefile automatically discovers sources.
* Keep `include/` for shared constants, syscall numbers, macros, and structure definitions.
* Use the `tests/` directory for portable C tests; the test-runner compiles and runs them automatically.
* The repository uses `build/` for generated files — include it in `.gitignore`.
